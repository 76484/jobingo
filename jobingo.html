<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Jobingo!</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style type="text/css">
      h1 {
        text-align: center;
      }

      button#Spin {
        background: green;
        border: 0;
        border-radius: 5px;
        color: white;
        cursor: pointer;
        display: block;
        font-weight: bold;
        margin: 0 auto 20px;
        padding: 10px 20px;
      }

      ul {
        list-style: none;
        margin: 0 auto;
        padding: 0;
      }

      li {
        text-align: center;
        text-decoration: line-through;
      }

      #Current {
        font-size: 48px;
        font-weight: bold;
        margin: 20px 0;
        text-align: center;
      }

      .called {
        background: grey;
      }
    </style>
  </head>
  <body>
    <h1>
      Jobingo!
    </h1>

    <button id="Spin">
      Spin the Wheel!
    </button>

    <div id="BoardContainer"></div>

    <div id="Current"></div>

    <ul id="Played"></ul>

    <script id="BoardTemplate" type="text/template">
      <table>
        <thead>
          <tr>
            <th>B</th>
            <th>I</th>
            <th>N</th>
            <th>G</th>
            <th>O</th>
          </tr>
        </thead>
        <tbody>
          {{#each rows}}
            <tr>
              {{#each ../columns as |col|}}
                <td>
                  {{#isFreeCell col @../index}}
                    <div class="called">FREE</div>
                  {{else}}
                    {{#with (lookup (lookup ../../board col) @../index) as |val|}}
                      <div class="{{#isCalled val @root/called}}called{{/isCalled}}">
                        {{val.display}}
                      </div>
                    {{/with}}
                  {{/isFreeCell}}
                </td>
              {{/each}}
            </tr>
          {{/each}}
        </tbody>
      </table>
    </script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/handlebars.js/4.7.6/handlebars.js"></script>
    <script>
      function shuffle(array) {
        var currentIndex = array.length,
          temporaryValue,
          randomIndex;

        // While there remain elements to shuffle...
        while (0 !== currentIndex) {
          // Pick a remaining element...
          randomIndex = Math.floor(Math.random() * currentIndex);
          currentIndex -= 1;

          // And swap it with the current element.
          temporaryValue = array[currentIndex];
          array[currentIndex] = array[randomIndex];
          array[randomIndex] = temporaryValue;
        }

        return array;
      }

      const makeValues = (key, startVal, length = 15) => {
        return [...Array(length).keys()].map((index) => {
          return {
            display: `${index + startVal}`,
            index,
            key,
          };
        });
      };

      const values = {
        b: makeValues("b", 1),
        i: makeValues("i", 16),
        n: makeValues("n", 31),
        g: makeValues("g", 46),
        o: makeValues("o", 61),
      };

      let allValues = Object.keys(values).reduce((acc, key) => {
        return acc.concat(values[key]);
      }, []);

      shuffle(allValues);

      const $current = document.getElementById("Current");
      const $spin = document.getElementById("Spin");
      const $played = document.getElementById("Played");

      let playIndex = 0;
      let called = {
        b: Array(15).fill(false),
        i: Array(15).fill(false),
        n: Array(15).fill(false),
        g: Array(15).fill(false),
        o: Array(15).fill(false),
      };

      // make board
      const $boardContainer = document.getElementById("BoardContainer");
      const $boardTemplateHtml = document.getElementById("BoardTemplate")
        .innerHTML;
      const boardTemplate = Handlebars.compile($boardTemplateHtml);

      const board = {
        b: shuffle(values.b.slice()).slice(0, 5),
        i: shuffle(values.i.slice()).slice(0, 5),
        n: shuffle(values.n.slice()).slice(0, 5),
        g: shuffle(values.g.slice()).slice(0, 5),
        o: shuffle(values.o.slice()).slice(0, 5),
      };

      // determine FREE cell and mark it as called.
      called["n"][board["n"][2].index] = true;

      Handlebars.registerHelper("isCalled", function (val, called, options) {
        if (called[val.key][val.index]) {
          return options.fn(this);
        }
        return options.inverse(this);
      });

      Handlebars.registerHelper("isFreeCell", function (col, row, options) {
        if (col === "n" && row === 2) {
          return options.fn(this);
        }
        return options.inverse(this);
      });

      const renderBoard = () => {
        $boardContainer.innerHTML = boardTemplate({
          board,
          called,
          columns: ["b", "i", "n", "g", "o"],
          rows: [0, 1, 2, 3, 4],
        });
      };

      // play
      $spin.addEventListener("click", () => {
        const value = allValues[playIndex];

        called[value.key][value.index] = true;
        $current.innerHTML = `${value.key.toUpperCase()} - ${value.display}`;

        if (playIndex > 0) {
          const $li = document.createElement("li");
          const prevValue = allValues[playIndex - 1];
          $li.innerHTML = `${prevValue.key.toUpperCase()} - ${
            prevValue.display
          }`;
          $played.prepend($li);
        }

        renderBoard(called);
        playIndex++;
      });

      renderBoard(called);
    </script>
  </body>
</html>
